const defaultExportRE = /^\s*export\s+default\s+(\[[\s\n]*\]|\{[\s\n]*\});?/m;
const defaultExportStartsWith = (content, char) => {
    const exportMatch = content.match(defaultExportRE);
    return exportMatch && exportMatch[1].charAt(0) === char;
};

function exportEsmCollectionLoader(content) {
    const { items, warnings } = this.query[0];
    const [type, open, close, entries] = Array.isArray(items)
        ? ['array', '[', ']', items]
        : ['object', '{', '}', Object.entries(items)];

    if (!defaultExportStartsWith(content, open)) {
        this.emitError(
            new Error(
                `items provided as ${type}, but cannot export an ${type} because template module "${
                    this.resourcePath
                }" does not export an empty ${type}.
            Note that comments are not allowed between the ${open} and ${close} for these template modules, but should be placed above the export declaration.

            Contents of "${this.resourcePath}":
            ${content}`
            )
        );
        return content;
    }

    if (entries.length === 0) {
        this.emitWarning(
            new Error(`Items array was empty; no changes will be made`)
        );
        return content;
    }

    const importStatements = [];
    const exportIdentifiers = [];
    for (const [toImport, toExport] of entries) {
        importStatements.push(toImport);
        exportIdentifiers.push(toExport);
    }
    // Leave a top comment if necessary
    const preamble = content.replace(defaultExportRE, '');
    const explanatory = `// generated by export-esm-collection-loader`;
    const importString = importStatements.join('\n');
    const exportList = exportIdentifiers.join(',\n  ');

    warnings.forEach(warning => this.emitWarning(new Error(warning)));

    return `${preamble}${explanatory}\n${importString}\n\nexport default ${open}\n  ${exportList}\n${close};`;
}

module.exports = exportEsmCollectionLoader;
